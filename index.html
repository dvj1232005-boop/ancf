<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>An Quy Chế – Hệ thống đăng ký ca</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0ea5a4">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#020617;
  --border:#0f172a;
  --primary:#0ea5a4;
  --accent:#facc15;
  --text:#e5e7eb;
}
*{box-sizing:border-box;font-family:system-ui}
body{margin:0;background:var(--bg);color:var(--text)}
header{
  padding:18px;
  font-size:20px;
  font-weight:700;
  background:linear-gradient(90deg,var(--primary),#22d3ee);
  color:#001014;
}
.card{
  border:1px solid var(--border);
  margin:16px;
  padding:16px;
  border-radius:16px;
}
button{
  background:var(--primary);
  border:none;
  padding:8px 16px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
}
button.alt{background:var(--accent);color:#111}
input,select{
  width:100%;
  padding:8px;
  margin-top:8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
}
th,td{
  border:1px solid var(--border);
  padding:6px;
  text-align:center;
  font-size:13px;
}
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  background:var(--accent);
  color:#111;
}
.hidden{display:none}
</style>
</head>

<body>

<header>AN QUY CHẾ – HỆ THỐNG ĐĂNG KÝ CA</header>

<!-- LOGIN -->
<div class="card" id="loginBox">
  <b>Đăng nhập</b>
  <input id="nameInput" placeholder="Nhập tên nhân viên">
  <button onclick="login()">Vào hệ thống</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

  <div class="card">
    <b id="hello"></b>
    <span class="badge" id="roleTag"></span>
    <button class="alt" onclick="logout()">Đăng xuất</button>
  </div>

  <!-- STAFF -->
  <div class="card" id="staffBox">
    <h3>Ca làm của bạn (tuần hiện tại)</h3>
    <div id="mySchedule"></div>
  </div>

  <!-- MANAGER -->
  <div class="card hidden" id="managerBox">
    <h3>Quản lý phân ca</h3>
    <select id="daySelect"></select>
    <select id="shiftSelect"></select>
    <div id="manageTable"></div>
  </div>

</div>

<script>
/* ========= FIREBASE CONFIG (THAY CỦA BẠN) ========= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========= DATA ========= */
const days = ["T2","T3","T4","T5","T6","T7","CN"];
const shifts = ["C1","F1","C2","F2","C3"];
let user = "";

/* ========= ISO WEEK (TỰ RESET TUẦN) ========= */
function getISOWeek(){
  const d = new Date();
  d.setHours(0,0,0,0);
  d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
  const week1 = new Date(d.getFullYear(),0,4);
  return d.getFullYear() + "-W" +
    String(
      1 + Math.round(
        ((d - week1) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7
      )
    ).padStart(2,"0");
}
const currentWeek = getISOWeek();

/* ========= LOGIN (AN TOÀN – KHÔNG TREO) ========= */
function login(){
  user = nameInput.value.trim();
  if(!user){
    alert("Bạn chưa nhập tên");
    return;
  }

  const role = user === "QuanLy" ? "manager" : "staff";
  localStorage.user = user;

  db.ref("users/" + user).set({ role })
    .then(start)
    .catch(err => alert("Lỗi Firebase: " + err.message));
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* ========= INIT ========= */
function start(){
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  hello.innerText = "Xin chào, " + user;

  db.ref("users/" + user + "/role").once("value", snap => {
    roleTag.innerText = snap.val();
    if(snap.val() === "manager"){
      managerBox.classList.remove("hidden");
      loadManager();
    }
    loadMySchedule();
  });
}

/* ========= STAFF ========= */
function loadMySchedule(){
  db.ref(`finalSchedule/${currentWeek}`).once("value", snap => {
    let html = "<table><tr><th>Thứ</th><th>Ca</th></tr>";
    snap.forEach(d => {
      d.forEach(c => {
        if(c.child(user).exists()){
          html += `<tr><td>${d.key}</td><td>${c.key}</td></tr>`;
        }
      });
    });
    html += "</table>";
    mySchedule.innerHTML = html;
  });
}

/* ========= MANAGER ========= */
function loadManager(){
  daySelect.innerHTML = days.map(d => `<option>${d}</option>`).join("");
  shiftSelect.innerHTML = shifts.map(s => `<option>${s}</option>`).join("");
  daySelect.onchange = shiftSelect.onchange = renderManage;
  renderManage();
}

function renderManage(){
  db.ref(`registrations/${currentWeek}/${daySelect.value}/${shiftSelect.value}`)
    .once("value", snap => {
      let html = "<table><tr><th>Nhân viên</th><th>Chọn</th></tr>";
      snap.forEach(c => {
        html += `
          <tr>
            <td>${c.key}</td>
            <td><input type="checkbox" onchange="pick('${c.key}',this.checked)"></td>
          </tr>`;
      });
      html += "</table>";
      manageTable.innerHTML = html;
    });
}

function pick(name, val){
  const ref = db.ref(`finalSchedule/${currentWeek}/${daySelect.value}/${shiftSelect.value}/${name}`);
  val ? ref.set(true) : ref.remove();
}

/* ========= AUTO LOGIN ========= */
if(localStorage.user){
  user = localStorage.user;
  start();
}

/* ========= SERVICE WORKER ========= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
